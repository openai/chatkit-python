
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../">
      
      
        <link rel="next" href="../errors/">
      
      
      <link rel="icon" href="../../../images/favicon-platform.svg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.21">
    
    
      
        <title>agents - Chatkit Python SDK</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.2a3383ac.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#agents" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Chatkit Python SDK" class="md-header__button md-logo" aria-label="Chatkit Python SDK" data-md-component="logo">
      
  <img src="../../../assets/logo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Chatkit Python SDK
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              agents
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/openai/chatkit-python" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    chatkit-python
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Chatkit Python SDK" class="md-nav__button md-logo" aria-label="Chatkit Python SDK" data-md-component="logo">
      
  <img src="../../../assets/logo.svg" alt="logo">

    </a>
    Chatkit Python SDK
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/openai/chatkit-python" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    chatkit-python
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../quickstart/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quick start
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Concepts
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Concepts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/threads/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Threads and items
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/thread-stream-events/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Thread stream events
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tools
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/widgets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Widgets
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/actions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Actions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/entities/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Entities
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Guides
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Guides
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/respond-to-user-message/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Respond to a user message
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/browse-past-threads/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Let users browse past threads
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/accept-rich-user-input/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Accept rich user input
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/let-users-pick-tools-and-models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Let users pick tools and models
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/pass-extra-app-context-to-your-model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pass extra app context to your model
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/update-client-during-response/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Update the client during a response
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/build-interactive-responses-with-widgets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Build interactive responses with widgets
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/add-annotations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Add annotations in assistant messages
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/stream-generated-images/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Stream generated images
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/keep-your-app-in-sync-with-chatkit/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Keep your app in sync with ChatKit
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/let-your-app-draft-and-send-messages/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Let your app draft and send messages
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/handle-feedback/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Handle feedback
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/prepare-your-app-for-production/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Prepare your app for production
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" checked>
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Modules
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            Modules
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    agents
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    agents
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#chatkit.agents" class="md-nav__link">
    <span class="md-ellipsis">
      agents
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chatkit.agents.ClientToolCall" class="md-nav__link">
    <span class="md-ellipsis">
      ClientToolCall
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chatkit.agents.AgentContext" class="md-nav__link">
    <span class="md-ellipsis">
      AgentContext
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AgentContext">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.AgentContext.generate_id" class="md-nav__link">
    <span class="md-ellipsis">
      generate_id
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.AgentContext.stream_widget" class="md-nav__link">
    <span class="md-ellipsis">
      stream_widget
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.AgentContext.end_workflow" class="md-nav__link">
    <span class="md-ellipsis">
      end_workflow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.AgentContext.start_workflow" class="md-nav__link">
    <span class="md-ellipsis">
      start_workflow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.AgentContext.update_workflow_task" class="md-nav__link">
    <span class="md-ellipsis">
      update_workflow_task
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.AgentContext.add_workflow_task" class="md-nav__link">
    <span class="md-ellipsis">
      add_workflow_task
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.AgentContext.stream" class="md-nav__link">
    <span class="md-ellipsis">
      stream
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chatkit.agents.ResponseStreamConverter" class="md-nav__link">
    <span class="md-ellipsis">
      ResponseStreamConverter
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ResponseStreamConverter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.ResponseStreamConverter.partial_images" class="md-nav__link">
    <span class="md-ellipsis">
      partial_images
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.ResponseStreamConverter.base64_image_to_url" class="md-nav__link">
    <span class="md-ellipsis">
      base64_image_to_url
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.ResponseStreamConverter.partial_image_index_to_progress" class="md-nav__link">
    <span class="md-ellipsis">
      partial_image_index_to_progress
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.ResponseStreamConverter.file_citation_to_annotation" class="md-nav__link">
    <span class="md-ellipsis">
      file_citation_to_annotation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.ResponseStreamConverter.container_file_citation_to_annotation" class="md-nav__link">
    <span class="md-ellipsis">
      container_file_citation_to_annotation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.ResponseStreamConverter.url_citation_to_annotation" class="md-nav__link">
    <span class="md-ellipsis">
      url_citation_to_annotation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chatkit.agents.ThreadItemConverter" class="md-nav__link">
    <span class="md-ellipsis">
      ThreadItemConverter
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ThreadItemConverter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.ThreadItemConverter.attachment_to_message_content" class="md-nav__link">
    <span class="md-ellipsis">
      attachment_to_message_content
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.ThreadItemConverter.tag_to_message_content" class="md-nav__link">
    <span class="md-ellipsis">
      tag_to_message_content
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.ThreadItemConverter.generated_image_to_input" class="md-nav__link">
    <span class="md-ellipsis">
      generated_image_to_input
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.ThreadItemConverter.hidden_context_to_input" class="md-nav__link">
    <span class="md-ellipsis">
      hidden_context_to_input
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.ThreadItemConverter.sdk_hidden_context_to_input" class="md-nav__link">
    <span class="md-ellipsis">
      sdk_hidden_context_to_input
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.ThreadItemConverter.task_to_input" class="md-nav__link">
    <span class="md-ellipsis">
      task_to_input
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.ThreadItemConverter.workflow_to_input" class="md-nav__link">
    <span class="md-ellipsis">
      workflow_to_input
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.ThreadItemConverter.widget_to_input" class="md-nav__link">
    <span class="md-ellipsis">
      widget_to_input
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chatkit.agents.stream_agent_response" class="md-nav__link">
    <span class="md-ellipsis">
      stream_agent_response
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chatkit.agents.simple_to_agent_input" class="md-nav__link">
    <span class="md-ellipsis">
      simple_to_agent_input
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../errors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    errors
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../server/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    server
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../store/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    store
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../types/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    types
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../widgets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    widgets
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../icons/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    icons
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../release/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Release process / changelog
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="https://openai.github.io/chatkit-js/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ChatKit JS Docs
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#chatkit.agents" class="md-nav__link">
    <span class="md-ellipsis">
      agents
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chatkit.agents.ClientToolCall" class="md-nav__link">
    <span class="md-ellipsis">
      ClientToolCall
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chatkit.agents.AgentContext" class="md-nav__link">
    <span class="md-ellipsis">
      AgentContext
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AgentContext">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.AgentContext.generate_id" class="md-nav__link">
    <span class="md-ellipsis">
      generate_id
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.AgentContext.stream_widget" class="md-nav__link">
    <span class="md-ellipsis">
      stream_widget
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.AgentContext.end_workflow" class="md-nav__link">
    <span class="md-ellipsis">
      end_workflow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.AgentContext.start_workflow" class="md-nav__link">
    <span class="md-ellipsis">
      start_workflow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.AgentContext.update_workflow_task" class="md-nav__link">
    <span class="md-ellipsis">
      update_workflow_task
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.AgentContext.add_workflow_task" class="md-nav__link">
    <span class="md-ellipsis">
      add_workflow_task
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.AgentContext.stream" class="md-nav__link">
    <span class="md-ellipsis">
      stream
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chatkit.agents.ResponseStreamConverter" class="md-nav__link">
    <span class="md-ellipsis">
      ResponseStreamConverter
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ResponseStreamConverter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.ResponseStreamConverter.partial_images" class="md-nav__link">
    <span class="md-ellipsis">
      partial_images
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.ResponseStreamConverter.base64_image_to_url" class="md-nav__link">
    <span class="md-ellipsis">
      base64_image_to_url
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.ResponseStreamConverter.partial_image_index_to_progress" class="md-nav__link">
    <span class="md-ellipsis">
      partial_image_index_to_progress
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.ResponseStreamConverter.file_citation_to_annotation" class="md-nav__link">
    <span class="md-ellipsis">
      file_citation_to_annotation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.ResponseStreamConverter.container_file_citation_to_annotation" class="md-nav__link">
    <span class="md-ellipsis">
      container_file_citation_to_annotation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.ResponseStreamConverter.url_citation_to_annotation" class="md-nav__link">
    <span class="md-ellipsis">
      url_citation_to_annotation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chatkit.agents.ThreadItemConverter" class="md-nav__link">
    <span class="md-ellipsis">
      ThreadItemConverter
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ThreadItemConverter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.ThreadItemConverter.attachment_to_message_content" class="md-nav__link">
    <span class="md-ellipsis">
      attachment_to_message_content
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.ThreadItemConverter.tag_to_message_content" class="md-nav__link">
    <span class="md-ellipsis">
      tag_to_message_content
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.ThreadItemConverter.generated_image_to_input" class="md-nav__link">
    <span class="md-ellipsis">
      generated_image_to_input
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.ThreadItemConverter.hidden_context_to_input" class="md-nav__link">
    <span class="md-ellipsis">
      hidden_context_to_input
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.ThreadItemConverter.sdk_hidden_context_to_input" class="md-nav__link">
    <span class="md-ellipsis">
      sdk_hidden_context_to_input
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.ThreadItemConverter.task_to_input" class="md-nav__link">
    <span class="md-ellipsis">
      task_to_input
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.ThreadItemConverter.workflow_to_input" class="md-nav__link">
    <span class="md-ellipsis">
      workflow_to_input
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chatkit.agents.ThreadItemConverter.widget_to_input" class="md-nav__link">
    <span class="md-ellipsis">
      widget_to_input
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chatkit.agents.stream_agent_response" class="md-nav__link">
    <span class="md-ellipsis">
      stream_agent_response
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chatkit.agents.simple_to_agent_input" class="md-nav__link">
    <span class="md-ellipsis">
      simple_to_agent_input
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="agents">agents</h1>


<div class="doc doc-object doc-module">



<a id="chatkit.agents"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="chatkit.agents.ClientToolCall" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">ClientToolCall</span>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="pydantic.BaseModel">BaseModel</span></code></p>


        <p>Returned from tool methods to indicate a client-side tool call.</p>








              <details class="quote">
                <summary>Source code in <code>chatkit/agents.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span>
<span class="normal">98</span>
<span class="normal">99</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ClientToolCall</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returned from tool methods to indicate a client-side tool call.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">arguments</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="chatkit.agents.AgentContext" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">AgentContext</span>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="pydantic.BaseModel">BaseModel</span></code>, <code><span title="typing.Generic">Generic</span>[<span title="chatkit.agents.TContext">TContext</span>]</code></p>









              <details class="quote">
                <summary>Source code in <code>chatkit/agents.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AgentContext</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">,</span> <span class="n">Generic</span><span class="p">[</span><span class="n">TContext</span><span class="p">]):</span>
    <span class="n">model_config</span> <span class="o">=</span> <span class="n">ConfigDict</span><span class="p">(</span><span class="n">arbitrary_types_allowed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">thread</span><span class="p">:</span> <span class="n">ThreadMetadata</span>
    <span class="n">store</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Store</span><span class="p">[</span><span class="n">TContext</span><span class="p">],</span> <span class="n">SkipValidation</span><span class="p">]</span>
    <span class="n">request_context</span><span class="p">:</span> <span class="n">TContext</span>
    <span class="n">previous_response_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">client_tool_call</span><span class="p">:</span> <span class="n">ClientToolCall</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">workflow_item</span><span class="p">:</span> <span class="n">WorkflowItem</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">generated_image_item</span><span class="p">:</span> <span class="n">GeneratedImageItem</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_events</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">[</span><span class="n">ThreadStreamEvent</span> <span class="o">|</span> <span class="n">_QueueCompleteSentinel</span><span class="p">]</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_id</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="n">StoreItemType</span><span class="p">,</span> <span class="n">thread</span><span class="p">:</span> <span class="n">ThreadMetadata</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a new store-backed id for the given item type.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;thread&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">generate_thread_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_context</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">generate_item_id</span><span class="p">(</span>
            <span class="nb">type</span><span class="p">,</span> <span class="n">thread</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_context</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stream_widget</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">widget</span><span class="p">:</span> <span class="n">WidgetRoot</span> <span class="o">|</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="n">WidgetRoot</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
        <span class="n">copy_text</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stream a widget into the thread by enqueueing widget events.&quot;&quot;&quot;</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">stream_widget</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="p">,</span>
            <span class="n">widget</span><span class="p">,</span>
            <span class="n">copy_text</span><span class="p">,</span>
            <span class="k">lambda</span> <span class="n">item_type</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">generate_item_id</span><span class="p">(</span>
                <span class="n">item_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_context</span>
            <span class="p">),</span>
        <span class="p">):</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_events</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">end_workflow</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">summary</span><span class="p">:</span> <span class="n">WorkflowSummary</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">expanded</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Finalize the active workflow item, optionally attaching a summary.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_item</span><span class="p">:</span>
            <span class="c1"># No workflow to end</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">summary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">workflow_item</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">summary</span> <span class="o">=</span> <span class="n">summary</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_item</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">summary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># If no summary was set or provided, set a basic work summary</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_item</span><span class="o">.</span><span class="n">created_at</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">workflow_item</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">summary</span> <span class="o">=</span> <span class="n">DurationSummary</span><span class="p">(</span><span class="n">duration</span><span class="o">=</span><span class="n">duration</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workflow_item</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">expanded</span> <span class="o">=</span> <span class="n">expanded</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">ThreadItemDoneEvent</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow_item</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workflow_item</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start_workflow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workflow</span><span class="p">:</span> <span class="n">Workflow</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Begin streaming a new workflow item.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workflow_item</span> <span class="o">=</span> <span class="n">WorkflowItem</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_id</span><span class="p">(</span><span class="s2">&quot;workflow&quot;</span><span class="p">),</span>
            <span class="n">created_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="n">workflow</span><span class="o">=</span><span class="n">workflow</span><span class="p">,</span>
            <span class="n">thread_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">workflow</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;reasoning&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">workflow</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Defer sending added event until we have tasks</span>
            <span class="k">return</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">ThreadItemAddedEvent</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow_item</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_workflow_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">,</span> <span class="n">task_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update an existing workflow task and stream the delta.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_item</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Workflow is not set&quot;</span><span class="p">)</span>
        <span class="c1"># ensure reference is updated in case task is a copy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workflow_item</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="n">task_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span>
            <span class="n">ThreadItemUpdatedEvent</span><span class="p">(</span>
                <span class="n">item_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow_item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">update</span><span class="o">=</span><span class="n">WorkflowTaskUpdated</span><span class="p">(</span>
                    <span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span>
                    <span class="n">task_index</span><span class="o">=</span><span class="n">task_index</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">add_workflow_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Append a workflow task and stream the appropriate event.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workflow_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_item</span> <span class="ow">or</span> <span class="n">WorkflowItem</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_id</span><span class="p">(</span><span class="s2">&quot;workflow&quot;</span><span class="p">),</span>
            <span class="n">created_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="n">workflow</span><span class="o">=</span><span class="n">Workflow</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;custom&quot;</span><span class="p">,</span> <span class="n">tasks</span><span class="o">=</span><span class="p">[]),</span>
            <span class="n">thread_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">workflow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_item</span><span class="o">.</span><span class="n">workflow</span>
        <span class="n">workflow</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">workflow</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;reasoning&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">workflow</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">ThreadItemAddedEvent</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow_item</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span>
                <span class="n">ThreadItemUpdatedEvent</span><span class="p">(</span>
                    <span class="n">item_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow_item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">update</span><span class="o">=</span><span class="n">WorkflowTaskAdded</span><span class="p">(</span>
                        <span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span>
                        <span class="n">task_index</span><span class="o">=</span><span class="n">workflow</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">task</span><span class="p">),</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">ThreadStreamEvent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enqueue a ThreadStreamEvent for downstream processing.&quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_events</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_events</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">(</span><span class="n">_QueueCompleteSentinel</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="chatkit.agents.AgentContext.generate_id" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">generate_id</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">generate_id</span><span class="p">(</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n"><span title="chatkit.store.StoreItemType">StoreItemType</span></span><span class="p">,</span>
    <span class="n">thread</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="ThreadMetadata (chatkit.types.ThreadMetadata)" href="../types/#chatkit.types.ThreadMetadata">ThreadMetadata</a></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="str">str</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Generate a new store-backed id for the given item type.</p>


            <details class="quote">
              <summary>Source code in <code>chatkit/agents.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate_id</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="n">StoreItemType</span><span class="p">,</span> <span class="n">thread</span><span class="p">:</span> <span class="n">ThreadMetadata</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a new store-backed id for the given item type.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;thread&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">generate_thread_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_context</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">generate_item_id</span><span class="p">(</span>
        <span class="nb">type</span><span class="p">,</span> <span class="n">thread</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_context</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chatkit.agents.AgentContext.stream_widget" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">stream_widget</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">stream_widget</span><span class="p">(</span>
    <span class="n">widget</span><span class="p">:</span> <span class="n"><span title="chatkit.widgets.WidgetRoot">WidgetRoot</span></span> <span class="o">|</span> <span class="n"><span title="typing.AsyncGenerator">AsyncGenerator</span></span><span class="p">[</span><span class="n"><span title="chatkit.widgets.WidgetRoot">WidgetRoot</span></span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
    <span class="n">copy_text</span><span class="p">:</span> <span class="n"><span title="str">str</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Stream a widget into the thread by enqueueing widget events.</p>


            <details class="quote">
              <summary>Source code in <code>chatkit/agents.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stream_widget</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">widget</span><span class="p">:</span> <span class="n">WidgetRoot</span> <span class="o">|</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="n">WidgetRoot</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
    <span class="n">copy_text</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stream a widget into the thread by enqueueing widget events.&quot;&quot;&quot;</span>
    <span class="k">async</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">stream_widget</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="p">,</span>
        <span class="n">widget</span><span class="p">,</span>
        <span class="n">copy_text</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="n">item_type</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">generate_item_id</span><span class="p">(</span>
            <span class="n">item_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_context</span>
        <span class="p">),</span>
    <span class="p">):</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_events</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chatkit.agents.AgentContext.end_workflow" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">end_workflow</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">end_workflow</span><span class="p">(</span>
    <span class="n">summary</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="WorkflowSummary


  
      module-attribute
   (chatkit.types.WorkflowSummary)" href="../types/#chatkit.types.WorkflowSummary">WorkflowSummary</a></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">expanded</span><span class="p">:</span> <span class="n"><span title="bool">bool</span></span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Finalize the active workflow item, optionally attaching a summary.</p>


            <details class="quote">
              <summary>Source code in <code>chatkit/agents.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">end_workflow</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">summary</span><span class="p">:</span> <span class="n">WorkflowSummary</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">expanded</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Finalize the active workflow item, optionally attaching a summary.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_item</span><span class="p">:</span>
        <span class="c1"># No workflow to end</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">summary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workflow_item</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">summary</span> <span class="o">=</span> <span class="n">summary</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_item</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">summary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># If no summary was set or provided, set a basic work summary</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_item</span><span class="o">.</span><span class="n">created_at</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workflow_item</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">summary</span> <span class="o">=</span> <span class="n">DurationSummary</span><span class="p">(</span><span class="n">duration</span><span class="o">=</span><span class="n">duration</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">workflow_item</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">expanded</span> <span class="o">=</span> <span class="n">expanded</span>
    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">ThreadItemDoneEvent</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow_item</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">workflow_item</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chatkit.agents.AgentContext.start_workflow" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">start_workflow</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">start_workflow</span><span class="p">(</span><span class="n">workflow</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="Workflow (chatkit.types.Workflow)" href="../types/#chatkit.types.Workflow">Workflow</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Begin streaming a new workflow item.</p>


            <details class="quote">
              <summary>Source code in <code>chatkit/agents.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start_workflow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workflow</span><span class="p">:</span> <span class="n">Workflow</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Begin streaming a new workflow item.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">workflow_item</span> <span class="o">=</span> <span class="n">WorkflowItem</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_id</span><span class="p">(</span><span class="s2">&quot;workflow&quot;</span><span class="p">),</span>
        <span class="n">created_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
        <span class="n">workflow</span><span class="o">=</span><span class="n">workflow</span><span class="p">,</span>
        <span class="n">thread_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">workflow</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;reasoning&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">workflow</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Defer sending added event until we have tasks</span>
        <span class="k">return</span>

    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">ThreadItemAddedEvent</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow_item</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chatkit.agents.AgentContext.update_workflow_task" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">update_workflow_task</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">update_workflow_task</span><span class="p">(</span><span class="n">task</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="Task


  
      module-attribute
   (chatkit.types.Task)" href="../types/#chatkit.types.Task">Task</a></span><span class="p">,</span> <span class="n">task_index</span><span class="p">:</span> <span class="n"><span title="int">int</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Update an existing workflow task and stream the delta.</p>


            <details class="quote">
              <summary>Source code in <code>chatkit/agents.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_workflow_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">,</span> <span class="n">task_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update an existing workflow task and stream the delta.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_item</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Workflow is not set&quot;</span><span class="p">)</span>
    <span class="c1"># ensure reference is updated in case task is a copy</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">workflow_item</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="n">task_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span>
    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span>
        <span class="n">ThreadItemUpdatedEvent</span><span class="p">(</span>
            <span class="n">item_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow_item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">update</span><span class="o">=</span><span class="n">WorkflowTaskUpdated</span><span class="p">(</span>
                <span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span>
                <span class="n">task_index</span><span class="o">=</span><span class="n">task_index</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chatkit.agents.AgentContext.add_workflow_task" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">add_workflow_task</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">add_workflow_task</span><span class="p">(</span><span class="n">task</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="Task


  
      module-attribute
   (chatkit.types.Task)" href="../types/#chatkit.types.Task">Task</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Append a workflow task and stream the appropriate event.</p>


            <details class="quote">
              <summary>Source code in <code>chatkit/agents.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">add_workflow_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Append a workflow task and stream the appropriate event.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">workflow_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_item</span> <span class="ow">or</span> <span class="n">WorkflowItem</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_id</span><span class="p">(</span><span class="s2">&quot;workflow&quot;</span><span class="p">),</span>
        <span class="n">created_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
        <span class="n">workflow</span><span class="o">=</span><span class="n">Workflow</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;custom&quot;</span><span class="p">,</span> <span class="n">tasks</span><span class="o">=</span><span class="p">[]),</span>
        <span class="n">thread_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">workflow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_item</span><span class="o">.</span><span class="n">workflow</span>
    <span class="n">workflow</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">workflow</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;reasoning&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">workflow</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">ThreadItemAddedEvent</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow_item</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span>
            <span class="n">ThreadItemUpdatedEvent</span><span class="p">(</span>
                <span class="n">item_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow_item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">update</span><span class="o">=</span><span class="n">WorkflowTaskAdded</span><span class="p">(</span>
                    <span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span>
                    <span class="n">task_index</span><span class="o">=</span><span class="n">workflow</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">task</span><span class="p">),</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chatkit.agents.AgentContext.stream" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">stream</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">stream</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="ThreadStreamEvent


  
      module-attribute
   (chatkit.types.ThreadStreamEvent)" href="../types/#chatkit.types.ThreadStreamEvent">ThreadStreamEvent</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Enqueue a ThreadStreamEvent for downstream processing.</p>


            <details class="quote">
              <summary>Source code in <code>chatkit/agents.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">ThreadStreamEvent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enqueue a ThreadStreamEvent for downstream processing.&quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_events</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="chatkit.agents.ResponseStreamConverter" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">ResponseStreamConverter</span>


</h3>


    <div class="doc doc-contents ">


        <p>Used by <code>stream_agent_response</code> to convert streamed Agents SDK output
into values used by ChatKit thread items and thread stream events.</p>
<p>Defines overridable methods for adapting streamed data (such as image
generation results and partial updates) into the forms expected by ChatKit.</p>








              <details class="quote">
                <summary>Source code in <code>chatkit/agents.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ResponseStreamConverter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Used by `stream_agent_response` to convert streamed Agents SDK output</span>
<span class="sd">    into values used by ChatKit thread items and thread stream events.</span>

<span class="sd">    Defines overridable methods for adapting streamed data (such as image</span>
<span class="sd">    generation results and partial updates) into the forms expected by ChatKit.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">partial_images</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The expected number of partial image updates for an image generation result.</span>

<span class="sd">    When set, this value is used to normalize partial image indices into a</span>
<span class="sd">    progress value in the range [0, 1]. If unset, all partial image updates are</span>
<span class="sd">    assigned a progress value of 0.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">partial_images</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            partial_images: The expected number of partial image updates for image</span>
<span class="sd">                generation results, or None if no progress normalization should</span>
<span class="sd">                be performed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">partial_images</span> <span class="o">=</span> <span class="n">partial_images</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">base64_image_to_url</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">image_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">base64_image</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">partial_image_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a base64-encoded image into a URL.</span>

<span class="sd">        This method is used to produce the URL stored on thread items for image</span>
<span class="sd">        generation results.</span>

<span class="sd">        Args:</span>
<span class="sd">            image_id: The ID of the image generation call. This stays stable across partial image updates.</span>
<span class="sd">            base64_image: The base64-encoded image.</span>
<span class="sd">            partial_image_index: The index of the partial image update, starting from 0.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A URL string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;data:image/png;base64,</span><span class="si">{</span><span class="n">base64_image</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">partial_image_index_to_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">partial_image_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a partial image index into a normalized progress value.</span>

<span class="sd">        Args:</span>
<span class="sd">            partial_image_index: The index of the partial image update, starting from 0.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A float between 0 and 1 representing progress for the image</span>
<span class="sd">            generation result.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial_images</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial_images</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>

        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">partial_image_index</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial_images</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">file_citation_to_annotation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">file_citation</span><span class="p">:</span> <span class="n">AnnotationFileCitation</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Annotation</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert a Responses API file citation into an assistant message annotation.&quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">file_citation</span><span class="o">.</span><span class="n">filename</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">Annotation</span><span class="p">(</span>
            <span class="n">source</span><span class="o">=</span><span class="n">FileSource</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">filename</span><span class="p">),</span>
            <span class="n">index</span><span class="o">=</span><span class="n">file_citation</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">container_file_citation_to_annotation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">container_file_citation</span><span class="p">:</span> <span class="n">AnnotationContainerFileCitation</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Annotation</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert a Responses API container file citation into an assistant message annotation.&quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">container_file_citation</span><span class="o">.</span><span class="n">filename</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">Annotation</span><span class="p">(</span>
            <span class="n">source</span><span class="o">=</span><span class="n">FileSource</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">filename</span><span class="p">),</span>
            <span class="n">index</span><span class="o">=</span><span class="n">container_file_citation</span><span class="o">.</span><span class="n">end_index</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">url_citation_to_annotation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">url_citation</span><span class="p">:</span> <span class="n">AnnotationURLCitation</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Annotation</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert a Responses API URL citation into an assistant message annotation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Annotation</span><span class="p">(</span>
            <span class="n">source</span><span class="o">=</span><span class="n">URLSource</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url_citation</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">url_citation</span><span class="o">.</span><span class="n">title</span><span class="p">),</span>
            <span class="n">index</span><span class="o">=</span><span class="n">url_citation</span><span class="o">.</span><span class="n">end_index</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h4 id="chatkit.agents.ResponseStreamConverter.partial_images" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">partial_images</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">partial_images</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n"><span title="chatkit.agents.ResponseStreamConverter(partial_images)">partial_images</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>The expected number of partial image updates for an image generation result.</p>
<p>When set, this value is used to normalize partial image indices into a
progress value in the range [0, 1]. If unset, all partial image updates are
assigned a progress value of 0.</p>

    </div>

</div>




<div class="doc doc-object doc-function">


<h4 id="chatkit.agents.ResponseStreamConverter.base64_image_to_url" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">base64_image_to_url</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">base64_image_to_url</span><span class="p">(</span>
    <span class="n">image_id</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">,</span>
    <span class="n">base64_image</span><span class="p">:</span> <span class="n"><span title="str">str</span></span><span class="p">,</span>
    <span class="n">partial_image_index</span><span class="p">:</span> <span class="n"><span title="int">int</span></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="str">str</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Convert a base64-encoded image into a URL.</p>
<p>This method is used to produce the URL stored on thread items for image
generation results.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>image_id</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ID of the image generation call. This stays stable across partial image updates.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>base64_image</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The base64-encoded image.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>partial_image_index</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The index of the partial image update, starting from 0.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A URL string.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>chatkit/agents.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">base64_image_to_url</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">image_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">base64_image</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">partial_image_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a base64-encoded image into a URL.</span>

<span class="sd">    This method is used to produce the URL stored on thread items for image</span>
<span class="sd">    generation results.</span>

<span class="sd">    Args:</span>
<span class="sd">        image_id: The ID of the image generation call. This stays stable across partial image updates.</span>
<span class="sd">        base64_image: The base64-encoded image.</span>
<span class="sd">        partial_image_index: The index of the partial image update, starting from 0.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A URL string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;data:image/png;base64,</span><span class="si">{</span><span class="n">base64_image</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chatkit.agents.ResponseStreamConverter.partial_image_index_to_progress" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">partial_image_index_to_progress</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">partial_image_index_to_progress</span><span class="p">(</span>
    <span class="n">partial_image_index</span><span class="p">:</span> <span class="n"><span title="int">int</span></span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="float">float</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Convert a partial image index into a normalized progress value.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>partial_image_index</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The index of the partial image update, starting from 0.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A float between 0 and 1 representing progress for the image</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>generation result.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>chatkit/agents.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">partial_image_index_to_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">partial_image_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a partial image index into a normalized progress value.</span>

<span class="sd">    Args:</span>
<span class="sd">        partial_image_index: The index of the partial image update, starting from 0.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A float between 0 and 1 representing progress for the image</span>
<span class="sd">        generation result.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial_images</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial_images</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>

    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">partial_image_index</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial_images</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chatkit.agents.ResponseStreamConverter.file_citation_to_annotation" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">file_citation_to_annotation</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">file_citation_to_annotation</span><span class="p">(</span>
    <span class="n">file_citation</span><span class="p">:</span> <span class="n"><span title="openai.types.responses.response_output_text.AnnotationFileCitation">AnnotationFileCitation</span></span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Annotation (chatkit.types.Annotation)" href="../types/#chatkit.types.Annotation">Annotation</a></span> <span class="o">|</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Convert a Responses API file citation into an assistant message annotation.</p>


            <details class="quote">
              <summary>Source code in <code>chatkit/agents.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">file_citation_to_annotation</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">file_citation</span><span class="p">:</span> <span class="n">AnnotationFileCitation</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Annotation</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a Responses API file citation into an assistant message annotation.&quot;&quot;&quot;</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">file_citation</span><span class="o">.</span><span class="n">filename</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">Annotation</span><span class="p">(</span>
        <span class="n">source</span><span class="o">=</span><span class="n">FileSource</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">filename</span><span class="p">),</span>
        <span class="n">index</span><span class="o">=</span><span class="n">file_citation</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chatkit.agents.ResponseStreamConverter.container_file_citation_to_annotation" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">container_file_citation_to_annotation</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">container_file_citation_to_annotation</span><span class="p">(</span>
    <span class="n">container_file_citation</span><span class="p">:</span> <span class="n"><span title="openai.types.responses.response_output_text.AnnotationContainerFileCitation">AnnotationContainerFileCitation</span></span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Annotation (chatkit.types.Annotation)" href="../types/#chatkit.types.Annotation">Annotation</a></span> <span class="o">|</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Convert a Responses API container file citation into an assistant message annotation.</p>


            <details class="quote">
              <summary>Source code in <code>chatkit/agents.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">container_file_citation_to_annotation</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">container_file_citation</span><span class="p">:</span> <span class="n">AnnotationContainerFileCitation</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Annotation</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a Responses API container file citation into an assistant message annotation.&quot;&quot;&quot;</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">container_file_citation</span><span class="o">.</span><span class="n">filename</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">Annotation</span><span class="p">(</span>
        <span class="n">source</span><span class="o">=</span><span class="n">FileSource</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">filename</span><span class="p">),</span>
        <span class="n">index</span><span class="o">=</span><span class="n">container_file_citation</span><span class="o">.</span><span class="n">end_index</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chatkit.agents.ResponseStreamConverter.url_citation_to_annotation" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">url_citation_to_annotation</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">url_citation_to_annotation</span><span class="p">(</span>
    <span class="n">url_citation</span><span class="p">:</span> <span class="n"><span title="openai.types.responses.response_output_text.AnnotationURLCitation">AnnotationURLCitation</span></span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="Annotation (chatkit.types.Annotation)" href="../types/#chatkit.types.Annotation">Annotation</a></span> <span class="o">|</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Convert a Responses API URL citation into an assistant message annotation.</p>


            <details class="quote">
              <summary>Source code in <code>chatkit/agents.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">url_citation_to_annotation</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">url_citation</span><span class="p">:</span> <span class="n">AnnotationURLCitation</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Annotation</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a Responses API URL citation into an assistant message annotation.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Annotation</span><span class="p">(</span>
        <span class="n">source</span><span class="o">=</span><span class="n">URLSource</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url_citation</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">url_citation</span><span class="o">.</span><span class="n">title</span><span class="p">),</span>
        <span class="n">index</span><span class="o">=</span><span class="n">url_citation</span><span class="o">.</span><span class="n">end_index</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="chatkit.agents.ThreadItemConverter" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">ThreadItemConverter</span>


</h3>


    <div class="doc doc-contents ">


        <p>Converts thread items to Agent SDK input items.
Widgets, Tasks, and Workflows have default conversions but can be customized.
Attachments, Tags, and HiddenContextItems require custom handling based on the use case.
Other item types are converted automatically.</p>








              <details class="quote">
                <summary>Source code in <code>chatkit/agents.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ThreadItemConverter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts thread items to Agent SDK input items.</span>
<span class="sd">    Widgets, Tasks, and Workflows have default conversions but can be customized.</span>
<span class="sd">    Attachments, Tags, and HiddenContextItems require custom handling based on the use case.</span>
<span class="sd">    Other item types are converted automatically.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">attachment_to_message_content</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">attachment</span><span class="p">:</span> <span class="n">Attachment</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ResponseInputContentParam</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert an attachment in a user message into a message content part to send to the model.</span>
<span class="sd">        Required when attachments are enabled.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;An Attachment was included in a UserMessageItem but Converter.attachment_to_message_content was not implemented&quot;</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">tag_to_message_content</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="n">UserMessageTagContent</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ResponseInputContentParam</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a tag in a user message into a message content part to send to the model as context.</span>
<span class="sd">        Required when tags are used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;A Tag was included in a UserMessageItem but Converter.tag_to_message_content is not implemented&quot;</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generated_image_to_input</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">GeneratedImageItem</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TResponseInputItem</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">TResponseInputItem</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a GeneratedImageItem into input item(s) to send to the model.</span>
<span class="sd">        Override this method to customize the conversion of generated images, such as when your</span>
<span class="sd">        generated image url is not publicly reachable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="o">.</span><span class="n">image</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">Message</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="p">[</span>
                <span class="n">ResponseInputTextParam</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;input_text&quot;</span><span class="p">,</span>
                    <span class="n">text</span><span class="o">=</span><span class="s2">&quot;The following image was generated by the agent.&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">ResponseInputImageParam</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;input_image&quot;</span><span class="p">,</span>
                    <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
                    <span class="n">image_url</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">],</span>
            <span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">hidden_context_to_input</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">HiddenContextItem</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TResponseInputItem</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">TResponseInputItem</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a HiddenContextItem into input item(s) to send to the model.</span>
<span class="sd">        Required to override when HiddenContextItems with non-string content are used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;HiddenContextItems with non-string content were present in a user message but a Converter.hidden_context_to_input was not implemented&quot;</span>
            <span class="p">)</span>

        <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Hidden context for the agent (not shown to the user):</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;&lt;HiddenContext&gt;</span><span class="se">\n</span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">content</span><span class="si">}</span><span class="se">\n</span><span class="s2">&lt;/HiddenContext&gt;&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">Message</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="p">[</span>
                <span class="n">ResponseInputTextParam</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;input_text&quot;</span><span class="p">,</span>
                    <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">],</span>
            <span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">sdk_hidden_context_to_input</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">SDKHiddenContextItem</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TResponseInputItem</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">TResponseInputItem</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a SDKHiddenContextItem into input item to send to the model.</span>
<span class="sd">        This is used by the ChatKit Python SDK for storing additional context</span>
<span class="sd">        for internal operations.</span>
<span class="sd">        Override if you want to wrap the content in a different format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Hidden context for the agent (not shown to the user):</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;&lt;HiddenContext&gt;</span><span class="se">\n</span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">content</span><span class="si">}</span><span class="se">\n</span><span class="s2">&lt;/HiddenContext&gt;&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">Message</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="p">[</span>
                <span class="n">ResponseInputTextParam</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;input_text&quot;</span><span class="p">,</span>
                    <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">],</span>
            <span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">task_to_input</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">TaskItem</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TResponseInputItem</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">TResponseInputItem</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a TaskItem into input item(s) to send to the model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;custom&quot;</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">item</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">title</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">item</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">content</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">title</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">content</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">content</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">task_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">content</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">title</span> <span class="ow">and</span> <span class="n">content</span> <span class="k">else</span> <span class="n">title</span> <span class="ow">or</span> <span class="n">content</span>
        <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;A message was displayed to the user that the following task was performed:</span><span class="se">\n</span><span class="s2">&lt;Task&gt;</span><span class="se">\n</span><span class="si">{</span><span class="n">task_text</span><span class="si">}</span><span class="se">\n</span><span class="s2">&lt;/Task&gt;&quot;</span>
        <span class="k">return</span> <span class="n">Message</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="p">[</span>
                <span class="n">ResponseInputTextParam</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;input_text&quot;</span><span class="p">,</span>
                    <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">],</span>
            <span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">workflow_to_input</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">WorkflowItem</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TResponseInputItem</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">TResponseInputItem</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a TaskItem into input item(s) to send to the model.</span>
<span class="sd">        Returns WorkflowItem.response_items by default.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;custom&quot;</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">task</span><span class="o">.</span><span class="n">title</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">task</span><span class="o">.</span><span class="n">content</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">title</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="n">content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">content</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">content</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="n">task_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">content</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">title</span> <span class="ow">and</span> <span class="n">content</span> <span class="k">else</span> <span class="n">title</span> <span class="ow">or</span> <span class="n">content</span>
            <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;A message was displayed to the user that the following task was performed:</span><span class="se">\n</span><span class="s2">&lt;Task&gt;</span><span class="se">\n</span><span class="si">{</span><span class="n">task_text</span><span class="si">}</span><span class="se">\n</span><span class="s2">&lt;/Task&gt;&quot;</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">Message</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
                    <span class="n">content</span><span class="o">=</span><span class="p">[</span>
                        <span class="n">ResponseInputTextParam</span><span class="p">(</span>
                            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;input_text&quot;</span><span class="p">,</span>
                            <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">],</span>
                    <span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">messages</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">widget_to_input</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">WidgetItem</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TResponseInputItem</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">TResponseInputItem</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a WidgetItem into input item(s) to send to the model.</span>
<span class="sd">        By default, WidgetItems converted to a text description with a JSON representation of the widget.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Message</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="p">[</span>
                <span class="n">ResponseInputTextParam</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;input_text&quot;</span><span class="p">,</span>
                    <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;The following graphical UI widget (id: </span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">) was displayed to the user:&quot;</span>
                    <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">model_dump_json</span><span class="p">(</span>
                        <span class="n">exclude_unset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exclude_none</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="p">],</span>
            <span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">user_message_to_input</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">UserMessageItem</span><span class="p">,</span> <span class="n">is_last_message</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TResponseInputItem</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">TResponseInputItem</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Build the user text exactly as typed, rendering tags as @key</span>
        <span class="n">message_text_parts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Track tags separately to add system context</span>
        <span class="n">raw_tags</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">UserMessageTagContent</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">UserMessageTextContent</span><span class="p">):</span>
                <span class="n">message_text_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">UserMessageTagContent</span><span class="p">):</span>
                <span class="n">message_text_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;@</span><span class="si">{</span><span class="n">part</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">raw_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">assert_never</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>

        <span class="n">user_text_item</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span>
            <span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="p">[</span>
                <span class="n">ResponseInputTextParam</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;input_text&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">message_text_parts</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="o">*</span><span class="p">[</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">attachment_to_message_content</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">attachments</span>
                <span class="p">],</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># Build system items (prepend later): quoted text and @-mention context</span>
        <span class="n">context_items</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TResponseInputItem</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">quoted_text</span> <span class="ow">and</span> <span class="n">is_last_message</span><span class="p">:</span>
            <span class="n">context_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">Message</span><span class="p">(</span>
                    <span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
                    <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
                    <span class="n">content</span><span class="o">=</span><span class="p">[</span>
                        <span class="n">ResponseInputTextParam</span><span class="p">(</span>
                            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;input_text&quot;</span><span class="p">,</span>
                            <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;The user is referring to this in particular: </span><span class="se">\n</span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">quoted_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">],</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Dedupe tags (preserve order) and resolve to message content</span>
        <span class="k">if</span> <span class="n">raw_tags</span><span class="p">:</span>
            <span class="n">seen</span><span class="p">,</span> <span class="n">uniq_tags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(),</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">raw_tags</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">text</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                    <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                    <span class="n">uniq_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

            <span class="n">tag_content</span><span class="p">:</span> <span class="n">ResponseInputMessageContentListParam</span> <span class="o">=</span> <span class="p">[</span>
                <span class="c1"># should return summarized text items</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag_to_message_content</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">uniq_tags</span>
            <span class="p">]</span>

            <span class="k">if</span> <span class="n">tag_content</span><span class="p">:</span>
                <span class="n">context_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">Message</span><span class="p">(</span>
                        <span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
                        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
                        <span class="n">content</span><span class="o">=</span><span class="p">[</span>
                            <span class="n">ResponseInputTextParam</span><span class="p">(</span>
                                <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;input_text&quot;</span><span class="p">,</span>
                                <span class="n">text</span><span class="o">=</span><span class="n">cleandoc</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                                    # User-provided context for @-mentions</span>
<span class="s2">                                    - When referencing resolved entities, use their canonical names **without** &#39;@&#39;.</span>
<span class="s2">                                    - The &#39;@&#39; form appears only in user text and should not be echoed.</span>
<span class="s2">                                &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
                            <span class="p">),</span>
                            <span class="o">*</span><span class="n">tag_content</span><span class="p">,</span>
                        <span class="p">],</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">user_text_item</span><span class="p">,</span> <span class="o">*</span><span class="n">context_items</span><span class="p">]</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">assistant_message_to_input</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">AssistantMessageItem</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TResponseInputItem</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">TResponseInputItem</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">EasyInputMessageParam</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="p">[</span>
                <span class="c1"># content param doesn&#39;t support the assistant message content types</span>
                <span class="n">cast</span><span class="p">(</span>
                    <span class="n">ResponseInputContentParam</span><span class="p">,</span>
                    <span class="n">ResponseOutputText</span><span class="p">(</span>
                        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;output_text&quot;</span><span class="p">,</span>
                        <span class="n">text</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
                        <span class="n">annotations</span><span class="o">=</span><span class="p">[],</span>  <span class="c1"># TODO: these should be sent back as well</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(),</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">content</span>
            <span class="p">],</span>
            <span class="n">role</span><span class="o">=</span><span class="s2">&quot;assistant&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">client_tool_call_to_input</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">ClientToolCallItem</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TResponseInputItem</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">TResponseInputItem</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;pending&quot;</span><span class="p">:</span>
            <span class="c1"># Filter out pending tool calls - they cannot be sent to the model</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="n">ResponseFunctionToolCallParam</span><span class="p">(</span>
                <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;function_call&quot;</span><span class="p">,</span>
                <span class="n">call_id</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">call_id</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">arguments</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">arguments</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">FunctionCallOutput</span><span class="p">(</span>
                <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;function_call_output&quot;</span><span class="p">,</span>
                <span class="n">call_id</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">call_id</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">output</span><span class="p">),</span>
            <span class="p">),</span>
        <span class="p">]</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">end_of_turn_to_input</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">EndOfTurnItem</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TResponseInputItem</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">TResponseInputItem</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Only used for UI hints - you shouldn&#39;t need to override this</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_thread_item_to_input_item</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">item</span><span class="p">:</span> <span class="n">ThreadItem</span><span class="p">,</span>
        <span class="n">is_last_message</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">TResponseInputItem</span><span class="p">]:</span>
        <span class="k">match</span> <span class="n">item</span><span class="p">:</span>
            <span class="k">case</span> <span class="n">UserMessageItem</span><span class="p">():</span>
                <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_message_to_input</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">is_last_message</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
                <span class="k">return</span> <span class="n">out</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">out</span><span class="p">]</span>
            <span class="k">case</span> <span class="n">AssistantMessageItem</span><span class="p">():</span>
                <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">assistant_message_to_input</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
                <span class="k">return</span> <span class="n">out</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">out</span><span class="p">]</span>
            <span class="k">case</span> <span class="n">ClientToolCallItem</span><span class="p">():</span>
                <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_tool_call_to_input</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
                <span class="k">return</span> <span class="n">out</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">out</span><span class="p">]</span>
            <span class="k">case</span> <span class="n">EndOfTurnItem</span><span class="p">():</span>
                <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_of_turn_to_input</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
                <span class="k">return</span> <span class="n">out</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">out</span><span class="p">]</span>
            <span class="k">case</span> <span class="n">WidgetItem</span><span class="p">():</span>
                <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">widget_to_input</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
                <span class="k">return</span> <span class="n">out</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">out</span><span class="p">]</span>
            <span class="k">case</span> <span class="n">WorkflowItem</span><span class="p">():</span>
                <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_to_input</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
                <span class="k">return</span> <span class="n">out</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">out</span><span class="p">]</span>
            <span class="k">case</span> <span class="n">TaskItem</span><span class="p">():</span>
                <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_to_input</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
                <span class="k">return</span> <span class="n">out</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">out</span><span class="p">]</span>
            <span class="k">case</span> <span class="n">HiddenContextItem</span><span class="p">():</span>
                <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_context_to_input</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
                <span class="k">return</span> <span class="n">out</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">out</span><span class="p">]</span>
            <span class="k">case</span> <span class="n">SDKHiddenContextItem</span><span class="p">():</span>
                <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdk_hidden_context_to_input</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
                <span class="k">return</span> <span class="n">out</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">out</span><span class="p">]</span>
            <span class="k">case</span> <span class="n">GeneratedImageItem</span><span class="p">():</span>
                <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">generated_image_to_input</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
                <span class="k">return</span> <span class="n">out</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">out</span><span class="p">]</span>
            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
                <span class="n">assert_never</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">to_agent_input</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">thread_items</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ThreadItem</span><span class="p">]</span> <span class="o">|</span> <span class="n">ThreadItem</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">TResponseInputItem</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">thread_items</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">):</span>
            <span class="c1"># shallow copy in case caller mutates the list while we&#39;re iterating</span>
            <span class="n">thread_items</span> <span class="o">=</span> <span class="n">thread_items</span><span class="p">[:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">thread_items</span> <span class="o">=</span> <span class="p">[</span><span class="n">thread_items</span><span class="p">]</span>
        <span class="n">output</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TResponseInputItem</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">thread_items</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thread_item_to_input_item</span><span class="p">(</span>
                    <span class="n">item</span><span class="p">,</span>
                    <span class="n">is_last_message</span><span class="o">=</span><span class="n">item</span> <span class="ow">is</span> <span class="n">thread_items</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="chatkit.agents.ThreadItemConverter.attachment_to_message_content" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">attachment_to_message_content</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">attachment_to_message_content</span><span class="p">(</span>
    <span class="n">attachment</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="Attachment


  
      module-attribute
   (chatkit.types.Attachment)" href="../types/#chatkit.types.Attachment">Attachment</a></span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="openai.types.responses.ResponseInputContentParam">ResponseInputContentParam</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Convert an attachment in a user message into a message content part to send to the model.
Required when attachments are enabled.</p>


            <details class="quote">
              <summary>Source code in <code>chatkit/agents.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">attachment_to_message_content</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">attachment</span><span class="p">:</span> <span class="n">Attachment</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ResponseInputContentParam</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert an attachment in a user message into a message content part to send to the model.</span>
<span class="sd">    Required when attachments are enabled.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
        <span class="s2">&quot;An Attachment was included in a UserMessageItem but Converter.attachment_to_message_content was not implemented&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chatkit.agents.ThreadItemConverter.tag_to_message_content" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">tag_to_message_content</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">tag_to_message_content</span><span class="p">(</span>
    <span class="n">tag</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="UserMessageTagContent (chatkit.types.UserMessageTagContent)" href="../types/#chatkit.types.UserMessageTagContent">UserMessageTagContent</a></span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="openai.types.responses.ResponseInputContentParam">ResponseInputContentParam</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Convert a tag in a user message into a message content part to send to the model as context.
Required when tags are used.</p>


            <details class="quote">
              <summary>Source code in <code>chatkit/agents.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">tag_to_message_content</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="n">UserMessageTagContent</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ResponseInputContentParam</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a tag in a user message into a message content part to send to the model as context.</span>
<span class="sd">    Required when tags are used.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
        <span class="s2">&quot;A Tag was included in a UserMessageItem but Converter.tag_to_message_content is not implemented&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chatkit.agents.ThreadItemConverter.generated_image_to_input" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">generated_image_to_input</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">generated_image_to_input</span><span class="p">(</span>
    <span class="n">item</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="GeneratedImageItem (chatkit.types.GeneratedImageItem)" href="../types/#chatkit.types.GeneratedImageItem">GeneratedImageItem</a></span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="agents.TResponseInputItem">TResponseInputItem</span></span> <span class="o">|</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="agents.TResponseInputItem">TResponseInputItem</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Convert a GeneratedImageItem into input item(s) to send to the model.
Override this method to customize the conversion of generated images, such as when your
generated image url is not publicly reachable.</p>


            <details class="quote">
              <summary>Source code in <code>chatkit/agents.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generated_image_to_input</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">GeneratedImageItem</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TResponseInputItem</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">TResponseInputItem</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a GeneratedImageItem into input item(s) to send to the model.</span>
<span class="sd">    Override this method to customize the conversion of generated images, such as when your</span>
<span class="sd">    generated image url is not publicly reachable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="o">.</span><span class="n">image</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">Message</span><span class="p">(</span>
        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="p">[</span>
            <span class="n">ResponseInputTextParam</span><span class="p">(</span>
                <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;input_text&quot;</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="s2">&quot;The following image was generated by the agent.&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">ResponseInputImageParam</span><span class="p">(</span>
                <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;input_image&quot;</span><span class="p">,</span>
                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
                <span class="n">image_url</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">],</span>
        <span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chatkit.agents.ThreadItemConverter.hidden_context_to_input" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">hidden_context_to_input</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">hidden_context_to_input</span><span class="p">(</span>
    <span class="n">item</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="HiddenContextItem (chatkit.types.HiddenContextItem)" href="../types/#chatkit.types.HiddenContextItem">HiddenContextItem</a></span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="agents.TResponseInputItem">TResponseInputItem</span></span> <span class="o">|</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="agents.TResponseInputItem">TResponseInputItem</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Convert a HiddenContextItem into input item(s) to send to the model.
Required to override when HiddenContextItems with non-string content are used.</p>


            <details class="quote">
              <summary>Source code in <code>chatkit/agents.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">hidden_context_to_input</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">HiddenContextItem</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TResponseInputItem</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">TResponseInputItem</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a HiddenContextItem into input item(s) to send to the model.</span>
<span class="sd">    Required to override when HiddenContextItems with non-string content are used.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;HiddenContextItems with non-string content were present in a user message but a Converter.hidden_context_to_input was not implemented&quot;</span>
        <span class="p">)</span>

    <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Hidden context for the agent (not shown to the user):</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;&lt;HiddenContext&gt;</span><span class="se">\n</span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">content</span><span class="si">}</span><span class="se">\n</span><span class="s2">&lt;/HiddenContext&gt;&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">Message</span><span class="p">(</span>
        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="p">[</span>
            <span class="n">ResponseInputTextParam</span><span class="p">(</span>
                <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;input_text&quot;</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">],</span>
        <span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chatkit.agents.ThreadItemConverter.sdk_hidden_context_to_input" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">sdk_hidden_context_to_input</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">sdk_hidden_context_to_input</span><span class="p">(</span>
    <span class="n">item</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="SDKHiddenContextItem (chatkit.types.SDKHiddenContextItem)" href="../types/#chatkit.types.SDKHiddenContextItem">SDKHiddenContextItem</a></span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="agents.TResponseInputItem">TResponseInputItem</span></span> <span class="o">|</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="agents.TResponseInputItem">TResponseInputItem</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Convert a SDKHiddenContextItem into input item to send to the model.
This is used by the ChatKit Python SDK for storing additional context
for internal operations.
Override if you want to wrap the content in a different format.</p>


            <details class="quote">
              <summary>Source code in <code>chatkit/agents.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">sdk_hidden_context_to_input</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">SDKHiddenContextItem</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TResponseInputItem</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">TResponseInputItem</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a SDKHiddenContextItem into input item to send to the model.</span>
<span class="sd">    This is used by the ChatKit Python SDK for storing additional context</span>
<span class="sd">    for internal operations.</span>
<span class="sd">    Override if you want to wrap the content in a different format.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Hidden context for the agent (not shown to the user):</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;&lt;HiddenContext&gt;</span><span class="se">\n</span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">content</span><span class="si">}</span><span class="se">\n</span><span class="s2">&lt;/HiddenContext&gt;&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">Message</span><span class="p">(</span>
        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="p">[</span>
            <span class="n">ResponseInputTextParam</span><span class="p">(</span>
                <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;input_text&quot;</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">],</span>
        <span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chatkit.agents.ThreadItemConverter.task_to_input" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">task_to_input</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">task_to_input</span><span class="p">(</span>
    <span class="n">item</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="TaskItem (chatkit.types.TaskItem)" href="../types/#chatkit.types.TaskItem">TaskItem</a></span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="agents.TResponseInputItem">TResponseInputItem</span></span> <span class="o">|</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="agents.TResponseInputItem">TResponseInputItem</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Convert a TaskItem into input item(s) to send to the model.</p>


            <details class="quote">
              <summary>Source code in <code>chatkit/agents.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">task_to_input</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">TaskItem</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TResponseInputItem</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">TResponseInputItem</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a TaskItem into input item(s) to send to the model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;custom&quot;</span> <span class="ow">or</span> <span class="p">(</span>
        <span class="ow">not</span> <span class="n">item</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">title</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">item</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">content</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">title</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="n">content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">content</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">content</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="n">task_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">content</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">title</span> <span class="ow">and</span> <span class="n">content</span> <span class="k">else</span> <span class="n">title</span> <span class="ow">or</span> <span class="n">content</span>
    <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;A message was displayed to the user that the following task was performed:</span><span class="se">\n</span><span class="s2">&lt;Task&gt;</span><span class="se">\n</span><span class="si">{</span><span class="n">task_text</span><span class="si">}</span><span class="se">\n</span><span class="s2">&lt;/Task&gt;&quot;</span>
    <span class="k">return</span> <span class="n">Message</span><span class="p">(</span>
        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="p">[</span>
            <span class="n">ResponseInputTextParam</span><span class="p">(</span>
                <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;input_text&quot;</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">],</span>
        <span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chatkit.agents.ThreadItemConverter.workflow_to_input" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">workflow_to_input</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">workflow_to_input</span><span class="p">(</span>
    <span class="n">item</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="WorkflowItem (chatkit.types.WorkflowItem)" href="../types/#chatkit.types.WorkflowItem">WorkflowItem</a></span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="agents.TResponseInputItem">TResponseInputItem</span></span> <span class="o">|</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="agents.TResponseInputItem">TResponseInputItem</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Convert a TaskItem into input item(s) to send to the model.
Returns WorkflowItem.response_items by default.</p>


            <details class="quote">
              <summary>Source code in <code>chatkit/agents.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">967</span>
<span class="normal">968</span>
<span class="normal">969</span>
<span class="normal">970</span>
<span class="normal">971</span>
<span class="normal">972</span>
<span class="normal">973</span>
<span class="normal">974</span>
<span class="normal">975</span>
<span class="normal">976</span>
<span class="normal">977</span>
<span class="normal">978</span>
<span class="normal">979</span>
<span class="normal">980</span>
<span class="normal">981</span>
<span class="normal">982</span>
<span class="normal">983</span>
<span class="normal">984</span>
<span class="normal">985</span>
<span class="normal">986</span>
<span class="normal">987</span>
<span class="normal">988</span>
<span class="normal">989</span>
<span class="normal">990</span>
<span class="normal">991</span>
<span class="normal">992</span>
<span class="normal">993</span>
<span class="normal">994</span>
<span class="normal">995</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">workflow_to_input</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">WorkflowItem</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TResponseInputItem</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">TResponseInputItem</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a TaskItem into input item(s) to send to the model.</span>
<span class="sd">    Returns WorkflowItem.response_items by default.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;custom&quot;</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">task</span><span class="o">.</span><span class="n">title</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">task</span><span class="o">.</span><span class="n">content</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">title</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">content</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">content</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">task_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">content</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">title</span> <span class="ow">and</span> <span class="n">content</span> <span class="k">else</span> <span class="n">title</span> <span class="ow">or</span> <span class="n">content</span>
        <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;A message was displayed to the user that the following task was performed:</span><span class="se">\n</span><span class="s2">&lt;Task&gt;</span><span class="se">\n</span><span class="si">{</span><span class="n">task_text</span><span class="si">}</span><span class="se">\n</span><span class="s2">&lt;/Task&gt;&quot;</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">Message</span><span class="p">(</span>
                <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
                <span class="n">content</span><span class="o">=</span><span class="p">[</span>
                    <span class="n">ResponseInputTextParam</span><span class="p">(</span>
                        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;input_text&quot;</span><span class="p">,</span>
                        <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">],</span>
                <span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">messages</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="chatkit.agents.ThreadItemConverter.widget_to_input" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">widget_to_input</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">widget_to_input</span><span class="p">(</span>
    <span class="n">item</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="WidgetItem (chatkit.types.WidgetItem)" href="../types/#chatkit.types.WidgetItem">WidgetItem</a></span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="agents.TResponseInputItem">TResponseInputItem</span></span> <span class="o">|</span> <span class="n"><span title="list">list</span></span><span class="p">[</span><span class="n"><span title="agents.TResponseInputItem">TResponseInputItem</span></span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Convert a WidgetItem into input item(s) to send to the model.
By default, WidgetItems converted to a text description with a JSON representation of the widget.</p>


            <details class="quote">
              <summary>Source code in <code>chatkit/agents.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">widget_to_input</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">WidgetItem</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TResponseInputItem</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">TResponseInputItem</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a WidgetItem into input item(s) to send to the model.</span>
<span class="sd">    By default, WidgetItems converted to a text description with a JSON representation of the widget.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Message</span><span class="p">(</span>
        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;message&quot;</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="p">[</span>
            <span class="n">ResponseInputTextParam</span><span class="p">(</span>
                <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;input_text&quot;</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;The following graphical UI widget (id: </span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">) was displayed to the user:&quot;</span>
                <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">model_dump_json</span><span class="p">(</span>
                    <span class="n">exclude_unset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exclude_none</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="p">],</span>
        <span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h3 id="chatkit.agents.stream_agent_response" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">stream_agent_response</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">stream_agent_response</span><span class="p">(</span>
    <span class="n">context</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="AgentContext (chatkit.agents.AgentContext)" href="#chatkit.agents.AgentContext">AgentContext</a></span><span class="p">,</span>
    <span class="n">result</span><span class="p">:</span> <span class="n"><span title="agents.RunResultStreaming">RunResultStreaming</span></span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">converter</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="ResponseStreamConverter (chatkit.agents.ResponseStreamConverter)" href="#chatkit.agents.ResponseStreamConverter">ResponseStreamConverter</a></span> <span class="o">=</span> <span class="n"><span title="chatkit.agents._DEFAULT_RESPONSE_STREAM_CONVERTER">_DEFAULT_RESPONSE_STREAM_CONVERTER</span></span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="collections.abc.AsyncIterator">AsyncIterator</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="ThreadStreamEvent


  
      module-attribute
   (chatkit.types.ThreadStreamEvent)" href="../types/#chatkit.types.ThreadStreamEvent">ThreadStreamEvent</a></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Convert a streamed Agents SDK run into ChatKit thread stream events.</p>
<p>This function consumes a streaming run result and yields <code>ThreadStreamEvent</code>
objects as the run progresses.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>context</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="AgentContext (chatkit.agents.AgentContext)" href="#chatkit.agents.AgentContext">AgentContext</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The AgentContext to use for the stream.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>result</code>
            </td>
            <td>
                  <code><span title="agents.RunResultStreaming">RunResultStreaming</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The RunResultStreaming to convert.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>converter</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ResponseStreamConverter (chatkit.agents.ResponseStreamConverter)" href="#chatkit.agents.ResponseStreamConverter">ResponseStreamConverter</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Defines overridable methods for adapting streamed data (such as image
generation results and partial updates) into the forms expected by ChatKit.</p>
              </div>
            </td>
            <td>
                  <code><span title="chatkit.agents._DEFAULT_RESPONSE_STREAM_CONVERTER">_DEFAULT_RESPONSE_STREAM_CONVERTER</span></code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="collections.abc.AsyncIterator">AsyncIterator</span>[<a class="autorefs autorefs-internal" title="ThreadStreamEvent


  
      module-attribute
   (chatkit.types.ThreadStreamEvent)" href="../types/#chatkit.types.ThreadStreamEvent">ThreadStreamEvent</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An async iterator that yields thread stream events representing the run result.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>chatkit/agents.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stream_agent_response</span><span class="p">(</span>
    <span class="n">context</span><span class="p">:</span> <span class="n">AgentContext</span><span class="p">,</span>
    <span class="n">result</span><span class="p">:</span> <span class="n">RunResultStreaming</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">converter</span><span class="p">:</span> <span class="n">ResponseStreamConverter</span> <span class="o">=</span> <span class="n">_DEFAULT_RESPONSE_STREAM_CONVERTER</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="n">ThreadStreamEvent</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a streamed Agents SDK run into ChatKit thread stream events.</span>

<span class="sd">    This function consumes a streaming run result and yields `ThreadStreamEvent`</span>
<span class="sd">    objects as the run progresses.</span>

<span class="sd">    Args:</span>
<span class="sd">        context: The AgentContext to use for the stream.</span>
<span class="sd">        result: The RunResultStreaming to convert.</span>
<span class="sd">        converter: Defines overridable methods for adapting streamed data (such as image</span>
<span class="sd">            generation results and partial updates) into the forms expected by ChatKit.</span>

<span class="sd">    Returns:</span>
<span class="sd">        An async iterator that yields thread stream events representing the run result.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">current_item_id</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">current_tool_call</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="n">context</span>
    <span class="n">thread</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">thread</span>
    <span class="n">queue_iterator</span> <span class="o">=</span> <span class="n">_AsyncQueueIterator</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">_events</span><span class="p">)</span>
    <span class="n">produced_items</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">streaming_thought</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="n">StreamingThoughtTracker</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># item_id -&gt; content_index -&gt; annotation count</span>
    <span class="n">item_annotation_count</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">defaultdict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># check if the last item in the thread was a workflow or a client tool call</span>
    <span class="c1"># if it was a client tool call, check if the second last item was a workflow</span>
    <span class="c1"># if either was, continue the workflow</span>
    <span class="n">items</span> <span class="o">=</span> <span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">load_thread_items</span><span class="p">(</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;desc&quot;</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">request_context</span>
    <span class="p">)</span>
    <span class="n">last_item</span> <span class="o">=</span> <span class="n">items</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">second_last_item</span> <span class="o">=</span> <span class="n">items</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">last_item</span> <span class="ow">and</span> <span class="n">last_item</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;workflow&quot;</span><span class="p">:</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">workflow_item</span> <span class="o">=</span> <span class="n">last_item</span>
    <span class="k">elif</span> <span class="p">(</span>
        <span class="n">last_item</span>
        <span class="ow">and</span> <span class="n">last_item</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;client_tool_call&quot;</span>
        <span class="ow">and</span> <span class="n">second_last_item</span>
        <span class="ow">and</span> <span class="n">second_last_item</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;workflow&quot;</span>
    <span class="p">):</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">workflow_item</span> <span class="o">=</span> <span class="n">second_last_item</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">end_workflow</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="n">WorkflowItem</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="n">ctx</span><span class="o">.</span><span class="n">workflow_item</span><span class="p">:</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">workflow_item</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">item</span><span class="o">.</span><span class="n">created_at</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">summary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">item</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">summary</span> <span class="o">=</span> <span class="n">DurationSummary</span><span class="p">(</span><span class="n">duration</span><span class="o">=</span><span class="n">duration</span><span class="p">)</span>
        <span class="c1"># Default to closing all workflows</span>
        <span class="c1"># To keep a workflow open on completion, close it explicitly with</span>
        <span class="c1"># AgentContext.end_workflow(expanded=True)</span>
        <span class="n">item</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">expanded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">ThreadItemDoneEvent</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">item</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">_merge_generators</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stream_events</span><span class="p">(),</span> <span class="n">queue_iterator</span><span class="p">):</span>
            <span class="c1"># Events emitted from agent context helpers</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">_EventWrapper</span><span class="p">):</span>
                <span class="n">event</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">event</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;thread.item.added&quot;</span>
                    <span class="ow">or</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;thread.item.done&quot;</span>
                <span class="p">):</span>
                    <span class="c1"># End the current workflow if visual item is added after it</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">ctx</span><span class="o">.</span><span class="n">workflow_item</span>
                        <span class="ow">and</span> <span class="n">ctx</span><span class="o">.</span><span class="n">workflow_item</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">event</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">id</span>
                        <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;client_tool_call&quot;</span>
                        <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;hidden_context_item&quot;</span>
                    <span class="p">):</span>
                        <span class="k">yield</span> <span class="n">end_workflow</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">workflow_item</span><span class="p">)</span>

                    <span class="c1"># track the current workflow if one is added</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;thread.item.added&quot;</span>
                        <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;workflow&quot;</span>
                    <span class="p">):</span>
                        <span class="n">ctx</span><span class="o">.</span><span class="n">workflow_item</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">item</span>

                    <span class="c1"># track integration produced items so we can clean them up if</span>
                    <span class="c1"># there is a guardrail tripwire</span>
                    <span class="n">produced_items</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">event</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;run_item_stream_event&quot;</span><span class="p">:</span>
                <span class="n">event</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">item</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;tool_call_item&quot;</span>
                    <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">raw_item</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;function_call&quot;</span>
                <span class="p">):</span>
                    <span class="n">current_tool_call</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">raw_item</span><span class="o">.</span><span class="n">call_id</span>
                    <span class="n">current_item_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">raw_item</span><span class="o">.</span><span class="n">id</span>
                    <span class="k">assert</span> <span class="n">current_item_id</span>
                    <span class="n">produced_items</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">current_item_id</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;raw_response_event&quot;</span><span class="p">:</span>
                <span class="c1"># Ignore everything else that isn&#39;t a raw response event</span>
                <span class="k">continue</span>

            <span class="c1"># Handle Responses events</span>
            <span class="n">event</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">data</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;response.content_part.added&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">part</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;reasoning_text&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">content</span> <span class="o">=</span> <span class="k">await</span> <span class="n">_convert_content</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">part</span><span class="p">,</span> <span class="n">converter</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">ThreadItemUpdatedEvent</span><span class="p">(</span>
                    <span class="n">item_id</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">item_id</span><span class="p">,</span>
                    <span class="n">update</span><span class="o">=</span><span class="n">AssistantMessageContentPartAdded</span><span class="p">(</span>
                        <span class="n">content_index</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">content_index</span><span class="p">,</span>
                        <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;response.output_text.delta&quot;</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">ThreadItemUpdatedEvent</span><span class="p">(</span>
                    <span class="n">item_id</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">item_id</span><span class="p">,</span>
                    <span class="n">update</span><span class="o">=</span><span class="n">AssistantMessageContentPartTextDelta</span><span class="p">(</span>
                        <span class="n">content_index</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">content_index</span><span class="p">,</span>
                        <span class="n">delta</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;response.output_text.done&quot;</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">ThreadItemUpdatedEvent</span><span class="p">(</span>
                    <span class="n">item_id</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">item_id</span><span class="p">,</span>
                    <span class="n">update</span><span class="o">=</span><span class="n">AssistantMessageContentPartDone</span><span class="p">(</span>
                        <span class="n">content_index</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">content_index</span><span class="p">,</span>
                        <span class="n">content</span><span class="o">=</span><span class="n">AssistantMessageContent</span><span class="p">(</span>
                            <span class="n">text</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
                            <span class="n">annotations</span><span class="o">=</span><span class="p">[],</span>
                        <span class="p">),</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;response.output_text.annotation.added&quot;</span><span class="p">:</span>
                <span class="n">annotation</span> <span class="o">=</span> <span class="k">await</span> <span class="n">_convert_annotation</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">annotation</span><span class="p">,</span> <span class="n">converter</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">annotation</span><span class="p">:</span>
                    <span class="c1"># Manually track annotation indices per content part in case we drop an annotation that</span>
                    <span class="c1"># we can&#39;t convert to our internal representation (e.g. missing filename).</span>
                    <span class="n">annotation_index</span> <span class="o">=</span> <span class="n">item_annotation_count</span><span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">item_id</span><span class="p">][</span>
                        <span class="n">event</span><span class="o">.</span><span class="n">content_index</span>
                    <span class="p">]</span>
                    <span class="n">item_annotation_count</span><span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">item_id</span><span class="p">][</span><span class="n">event</span><span class="o">.</span><span class="n">content_index</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">annotation_index</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="p">)</span>
                    <span class="k">yield</span> <span class="n">ThreadItemUpdatedEvent</span><span class="p">(</span>
                        <span class="n">item_id</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">item_id</span><span class="p">,</span>
                        <span class="n">update</span><span class="o">=</span><span class="n">AssistantMessageContentPartAnnotationAdded</span><span class="p">(</span>
                            <span class="n">content_index</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">content_index</span><span class="p">,</span>
                            <span class="n">annotation_index</span><span class="o">=</span><span class="n">annotation_index</span><span class="p">,</span>
                            <span class="n">annotation</span><span class="o">=</span><span class="n">annotation</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;response.output_item.added&quot;</span><span class="p">:</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">item</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;reasoning&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ctx</span><span class="o">.</span><span class="n">workflow_item</span><span class="p">:</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="n">workflow_item</span> <span class="o">=</span> <span class="n">WorkflowItem</span><span class="p">(</span>
                        <span class="nb">id</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">generate_id</span><span class="p">(</span><span class="s2">&quot;workflow&quot;</span><span class="p">),</span>
                        <span class="n">created_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                        <span class="n">workflow</span><span class="o">=</span><span class="n">Workflow</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;reasoning&quot;</span><span class="p">,</span> <span class="n">tasks</span><span class="o">=</span><span class="p">[]),</span>
                        <span class="n">thread_id</span><span class="o">=</span><span class="n">thread</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">produced_items</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">workflow_item</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="n">ThreadItemAddedEvent</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">workflow_item</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">workflow_item</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">end_workflow</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">workflow_item</span><span class="p">)</span>
                    <span class="n">produced_items</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="n">ThreadItemAddedEvent</span><span class="p">(</span>
                        <span class="n">item</span><span class="o">=</span><span class="n">AssistantMessageItem</span><span class="p">(</span>
                            <span class="c1"># Reusing the Responses message ID</span>
                            <span class="nb">id</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                            <span class="n">thread_id</span><span class="o">=</span><span class="n">thread</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                            <span class="n">content</span><span class="o">=</span><span class="p">[</span>
                                <span class="k">await</span> <span class="n">_convert_content</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">converter</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">content</span>
                            <span class="p">],</span>
                            <span class="n">created_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;image_generation_call&quot;</span><span class="p">:</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="n">generated_image_item</span> <span class="o">=</span> <span class="n">GeneratedImageItem</span><span class="p">(</span>
                        <span class="nb">id</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">generate_id</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">),</span>
                        <span class="n">thread_id</span><span class="o">=</span><span class="n">thread</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                        <span class="n">created_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                        <span class="n">image</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">produced_items</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">generated_image_item</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="n">ThreadItemAddedEvent</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">generated_image_item</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;response.image_generation_call.partial_image&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ctx</span><span class="o">.</span><span class="n">generated_image_item</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">url</span> <span class="o">=</span> <span class="k">await</span> <span class="n">converter</span><span class="o">.</span><span class="n">base64_image_to_url</span><span class="p">(</span>
                    <span class="n">image_id</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">item_id</span><span class="p">,</span>
                    <span class="n">base64_image</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">partial_image_b64</span><span class="p">,</span>
                    <span class="n">partial_image_index</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">partial_image_index</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">progress</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">partial_image_index_to_progress</span><span class="p">(</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">partial_image_index</span>
                <span class="p">)</span>

                <span class="n">ctx</span><span class="o">.</span><span class="n">generated_image_item</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">GeneratedImage</span><span class="p">(</span>
                    <span class="nb">id</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">item_id</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span>
                <span class="p">)</span>

                <span class="k">yield</span> <span class="n">ThreadItemUpdatedEvent</span><span class="p">(</span>
                    <span class="n">item_id</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">generated_image_item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">update</span><span class="o">=</span><span class="n">GeneratedImageUpdated</span><span class="p">(</span>
                        <span class="n">image</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">generated_image_item</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="n">progress</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;response.reasoning_summary_text.delta&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ctx</span><span class="o">.</span><span class="n">workflow_item</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># stream the first thought in a new workflow so that we can show it earlier</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="n">workflow_item</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;reasoning&quot;</span>
                    <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">workflow_item</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="p">):</span>
                    <span class="n">streaming_thought</span> <span class="o">=</span> <span class="n">StreamingThoughtTracker</span><span class="p">(</span>
                        <span class="n">item_id</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">item_id</span><span class="p">,</span>
                        <span class="n">index</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">summary_index</span><span class="p">,</span>
                        <span class="n">task</span><span class="o">=</span><span class="n">ThoughtTask</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">delta</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="n">workflow_item</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">streaming_thought</span><span class="o">.</span><span class="n">task</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="n">ThreadItemUpdatedEvent</span><span class="p">(</span>
                        <span class="n">item_id</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">workflow_item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                        <span class="n">update</span><span class="o">=</span><span class="n">WorkflowTaskAdded</span><span class="p">(</span>
                            <span class="n">task</span><span class="o">=</span><span class="n">streaming_thought</span><span class="o">.</span><span class="n">task</span><span class="p">,</span>
                            <span class="n">task_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="p">(</span>
                    <span class="n">streaming_thought</span>
                    <span class="ow">and</span> <span class="n">streaming_thought</span><span class="o">.</span><span class="n">task</span> <span class="ow">in</span> <span class="n">ctx</span><span class="o">.</span><span class="n">workflow_item</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">tasks</span>
                    <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="n">streaming_thought</span><span class="o">.</span><span class="n">item_id</span>
                    <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">summary_index</span> <span class="o">==</span> <span class="n">streaming_thought</span><span class="o">.</span><span class="n">index</span>
                <span class="p">):</span>
                    <span class="n">streaming_thought</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">content</span> <span class="o">+=</span> <span class="n">event</span><span class="o">.</span><span class="n">delta</span>
                    <span class="k">yield</span> <span class="n">ThreadItemUpdatedEvent</span><span class="p">(</span>
                        <span class="n">item_id</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">workflow_item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                        <span class="n">update</span><span class="o">=</span><span class="n">WorkflowTaskUpdated</span><span class="p">(</span>
                            <span class="n">task</span><span class="o">=</span><span class="n">streaming_thought</span><span class="o">.</span><span class="n">task</span><span class="p">,</span>
                            <span class="n">task_index</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">workflow_item</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">index</span><span class="p">(</span>
                                <span class="n">streaming_thought</span><span class="o">.</span><span class="n">task</span>
                            <span class="p">),</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;response.reasoning_summary_text.done&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">workflow_item</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">streaming_thought</span>
                        <span class="ow">and</span> <span class="n">streaming_thought</span><span class="o">.</span><span class="n">task</span> <span class="ow">in</span> <span class="n">ctx</span><span class="o">.</span><span class="n">workflow_item</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">tasks</span>
                        <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">item_id</span> <span class="o">==</span> <span class="n">streaming_thought</span><span class="o">.</span><span class="n">item_id</span>
                        <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">summary_index</span> <span class="o">==</span> <span class="n">streaming_thought</span><span class="o">.</span><span class="n">index</span>
                    <span class="p">):</span>
                        <span class="n">task</span> <span class="o">=</span> <span class="n">streaming_thought</span><span class="o">.</span><span class="n">task</span>
                        <span class="n">task</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">text</span>
                        <span class="n">streaming_thought</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">update</span> <span class="o">=</span> <span class="n">WorkflowTaskUpdated</span><span class="p">(</span>
                            <span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span>
                            <span class="n">task_index</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">workflow_item</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">task</span><span class="p">),</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">task</span> <span class="o">=</span> <span class="n">ThoughtTask</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                        <span class="n">ctx</span><span class="o">.</span><span class="n">workflow_item</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
                        <span class="n">update</span> <span class="o">=</span> <span class="n">WorkflowTaskAdded</span><span class="p">(</span>
                            <span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span>
                            <span class="n">task_index</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">workflow_item</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">task</span><span class="p">),</span>
                        <span class="p">)</span>
                    <span class="k">yield</span> <span class="n">ThreadItemUpdatedEvent</span><span class="p">(</span>
                        <span class="n">item_id</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">workflow_item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                        <span class="n">update</span><span class="o">=</span><span class="n">update</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;response.output_item.done&quot;</span><span class="p">:</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">item</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span>
                    <span class="n">produced_items</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="n">ThreadItemDoneEvent</span><span class="p">(</span>
                        <span class="n">item</span><span class="o">=</span><span class="n">AssistantMessageItem</span><span class="p">(</span>
                            <span class="c1"># Reusing the Responses message ID</span>
                            <span class="nb">id</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                            <span class="n">thread_id</span><span class="o">=</span><span class="n">thread</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                            <span class="n">content</span><span class="o">=</span><span class="p">[</span>
                                <span class="k">await</span> <span class="n">_convert_content</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">converter</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">content</span>
                            <span class="p">],</span>
                            <span class="n">created_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;image_generation_call&quot;</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">result</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ctx</span><span class="o">.</span><span class="n">generated_image_item</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">url</span> <span class="o">=</span> <span class="k">await</span> <span class="n">converter</span><span class="o">.</span><span class="n">base64_image_to_url</span><span class="p">(</span>
                        <span class="n">image_id</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                        <span class="n">base64_image</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">result</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">image</span> <span class="o">=</span> <span class="n">GeneratedImage</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">)</span>

                    <span class="n">ctx</span><span class="o">.</span><span class="n">generated_image_item</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">image</span>
                    <span class="k">yield</span> <span class="n">ThreadItemDoneEvent</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">generated_image_item</span><span class="p">)</span>

                    <span class="n">ctx</span><span class="o">.</span><span class="n">generated_image_item</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">except</span> <span class="p">(</span><span class="n">InputGuardrailTripwireTriggered</span><span class="p">,</span> <span class="n">OutputGuardrailTripwireTriggered</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">item_id</span> <span class="ow">in</span> <span class="n">produced_items</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">ThreadItemRemovedEvent</span><span class="p">(</span><span class="n">item_id</span><span class="o">=</span><span class="n">item_id</span><span class="p">)</span>

        <span class="c1"># Drain remaining events without processing them</span>
        <span class="n">context</span><span class="o">.</span><span class="n">_complete</span><span class="p">()</span>
        <span class="n">queue_iterator</span><span class="o">.</span><span class="n">drain_and_complete</span><span class="p">()</span>

        <span class="k">raise</span>

    <span class="n">context</span><span class="o">.</span><span class="n">_complete</span><span class="p">()</span>

    <span class="c1"># Drain remaining events</span>
    <span class="k">async</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">queue_iterator</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">event</span><span class="o">.</span><span class="n">event</span>

    <span class="c1"># If there is still an active workflow at the end of the run, store</span>
    <span class="c1"># it&#39;s current state so that we can continue it in the next turn.</span>
    <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">workflow_item</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">add_thread_item</span><span class="p">(</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">workflow_item</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">request_context</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">client_tool_call</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">ThreadItemDoneEvent</span><span class="p">(</span>
            <span class="n">item</span><span class="o">=</span><span class="n">ClientToolCallItem</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">current_item_id</span>
                <span class="ow">or</span> <span class="n">context</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">generate_item_id</span><span class="p">(</span>
                    <span class="s2">&quot;tool_call&quot;</span><span class="p">,</span> <span class="n">thread</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">request_context</span>
                <span class="p">),</span>
                <span class="n">thread_id</span><span class="o">=</span><span class="n">thread</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">client_tool_call</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">arguments</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">client_tool_call</span><span class="o">.</span><span class="n">arguments</span><span class="p">,</span>
                <span class="n">created_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                <span class="n">call_id</span><span class="o">=</span><span class="n">current_tool_call</span>
                <span class="ow">or</span> <span class="n">context</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">generate_item_id</span><span class="p">(</span>
                    <span class="s2">&quot;tool_call&quot;</span><span class="p">,</span> <span class="n">thread</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">request_context</span>
                <span class="p">),</span>
            <span class="p">),</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="chatkit.agents.simple_to_agent_input" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">simple_to_agent_input</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">simple_to_agent_input</span><span class="p">(</span>
    <span class="n">thread_items</span><span class="p">:</span> <span class="n"><span title="typing.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="ThreadItem


  
      module-attribute
   (chatkit.types.ThreadItem)" href="../types/#chatkit.types.ThreadItem">ThreadItem</a></span><span class="p">]</span> <span class="o">|</span> <span class="n"><a class="autorefs autorefs-internal" title="ThreadItem


  
      module-attribute
   (chatkit.types.ThreadItem)" href="../types/#chatkit.types.ThreadItem">ThreadItem</a></span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Helper that converts thread items using the default ThreadItemConverter.</p>


            <details class="quote">
              <summary>Source code in <code>chatkit/agents.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">simple_to_agent_input</span><span class="p">(</span><span class="n">thread_items</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ThreadItem</span><span class="p">]</span> <span class="o">|</span> <span class="n">ThreadItem</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper that converts thread items using the default ThreadItemConverter.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_DEFAULT_CONVERTER</span><span class="o">.</span><span class="n">to_agent_input</span><span class="p">(</span><span class="n">thread_items</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["content.code.copy", "content.code.select", "navigation.path", "navigation.sections", "content.code.annotate"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>